<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Diagnóstico ROI - Evalúa la madurez de tu ecosistema de capacitación según la Metodología ROI de Phillips. Quiz interactivo de MAS Consultores, único partner oficial del ROI Institute en Latinoamérica.">
<title>Diagnóstico de Madurez ROI — Metodología Phillips Nivel 5 | MAS Consultores</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;0,9..40,800;0,9..40,900;1,9..40,400&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
<style>
  :root {
    --bg-main:#ffffff; --bg-light:#f7f9fc;
    --navy:#1a2e4a; --navy2:#243d61; --navy3:#0f1f33; --navy-deep:#0c1929;
    --brand-morado:#833d8e; --brand-amarillo:#edb321; --brand-verde:#009739; --brand-rojo:#d62216; --brand-azul:#23398d;
    --nivel1:#833d8e; --nivel2:#edb321; --nivel3:#009739; --nivel4:#d62216; --nivel5:#23398d;
    --text:#334155; --muted:#64748b; --border:#e2e8f0; --border-light:#f1f5f9;
    --shadow-sm:0 1px 3px rgba(26,46,74,0.04),0 4px 6px -1px rgba(26,46,74,0.06);
    --shadow-md:0 4px 6px rgba(26,46,74,0.04),0 10px 25px -3px rgba(26,46,74,0.08);
    --shadow-lg:0 10px 15px rgba(26,46,74,0.04),0 20px 40px -5px rgba(26,46,74,0.12);
    --shadow-xl:0 25px 50px -12px rgba(26,46,74,0.18);
    --radius-sm:12px; --radius-md:18px; --radius-lg:24px; --radius-xl:32px;
  }
  *{margin:0;padding:0;box-sizing:border-box}
  html{scroll-behavior:smooth}
  body{font-family:'DM Sans',system-ui,-apple-system,sans-serif;background:var(--bg-light);color:var(--text);overflow-x:hidden;line-height:1.7;-webkit-font-smoothing:antialiased;min-height:100vh}
  h1,h2,h3,h4{font-family:'Plus Jakarta Sans','DM Sans',sans-serif;color:var(--navy);line-height:1.15;letter-spacing:-0.02em}

  nav{position:fixed;top:0;width:100%;z-index:1000;background:rgba(255,255,255,0.95);backdrop-filter:blur(16px);border-bottom:1px solid var(--border)}
  .nav-inner{max-width:1180px;margin:auto;display:flex;align-items:center;justify-content:space-between;padding:0 24px;height:64px}
  .nav-back{color:var(--navy);text-decoration:none;font-size:13px;font-weight:600;display:flex;align-items:center;gap:6px;transition:color .2s}
  .nav-back:hover{color:var(--brand-morado)}

  .quiz-wrapper{max-width:800px;margin:0 auto;padding:100px 24px 60px}

  .progress-container{margin-bottom:40px}
  .progress-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
  .progress-label{font-size:13px;font-weight:700;color:var(--navy);text-transform:uppercase;letter-spacing:1px}
  .progress-step-text{font-size:13px;color:var(--muted);font-weight:600}
  .progress-bar-track{width:100%;height:8px;background:var(--border);border-radius:50px;overflow:hidden}
  .progress-bar-fill{height:100%;border-radius:50px;transition:width .6s cubic-bezier(.16,1,.3,1),background .4s;width:0%}

  .step{display:none;animation:fadeStep .5s ease}
  .step.active{display:block}
  @keyframes fadeStep{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}

  .step-card{background:#fff;border-radius:var(--radius-xl);padding:44px;box-shadow:var(--shadow-lg);border:1px solid var(--border-light)}
  .step-icon{font-size:40px;margin-bottom:16px;display:block}
  .step-title{font-size:clamp(22px,3.5vw,30px);font-weight:800;margin-bottom:8px}
  .step-subtitle{color:var(--muted);font-size:15px;margin-bottom:32px;line-height:1.6}

  .question-group{margin-bottom:28px}
  .question-label{font-size:14px;font-weight:700;color:var(--navy);margin-bottom:12px;display:block}

  .chips{display:flex;flex-wrap:wrap;gap:10px}
  .chip{padding:11px 20px;border-radius:50px;border:2px solid var(--border);background:#fff;font-size:14px;cursor:pointer;transition:all .25s;color:var(--text);font-family:inherit;font-weight:500}
  .chip:hover{border-color:var(--navy);background:var(--bg-light)}
  .chip.selected{background:var(--navy);color:#fff;border-color:var(--navy);transform:scale(1.03)}

  .phase-header{display:flex;align-items:center;gap:12px;margin-bottom:16px;margin-top:8px}
  .phase-dot{width:14px;height:14px;border-radius:50%;flex-shrink:0}
  .phase-name{font-size:15px;font-weight:800}
  .phase-desc{font-size:11px;color:var(--muted);font-weight:600;margin-left:auto;background:var(--bg-light);padding:3px 10px;border-radius:50px}
  .phase-divider{margin-top:32px;padding-top:4px}

  .check-item{display:flex;align-items:flex-start;gap:14px;padding:14px 16px;border-radius:var(--radius-sm);border:2px solid var(--border-light);background:#fff;cursor:pointer;transition:all .3s cubic-bezier(.16,1,.3,1);margin-bottom:8px;user-select:none}
  .check-item:hover{border-color:var(--border);background:var(--bg-light);transform:translateX(4px)}
  .check-item.checked{border-color:currentColor;background:color-mix(in srgb,currentColor 6%,white)}
  .check-box{width:24px;height:24px;border-radius:7px;border:2px solid var(--border);display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .3s cubic-bezier(.16,1,.3,1);margin-top:1px}
  .check-box svg{width:14px;height:14px;opacity:0;transform:scale(.5);transition:all .3s cubic-bezier(.16,1,.3,1)}
  .check-box svg path{stroke:#fff;stroke-width:3;stroke-linecap:round;stroke-linejoin:round;fill:none;stroke-dasharray:24;stroke-dashoffset:24;transition:stroke-dashoffset .4s cubic-bezier(.16,1,.3,1) .1s}
  .check-item.checked .check-box{border-color:currentColor;background:currentColor;transform:scale(1.1)}
  .check-item.checked .check-box svg{opacity:1;transform:scale(1)}
  .check-item.checked .check-box svg path{stroke-dashoffset:0}
  .check-text{font-size:13.5px;line-height:1.55;font-weight:500}

  .check-counter{display:flex;align-items:center;justify-content:center;gap:8px;padding:10px 20px;border-radius:50px;background:var(--bg-light);border:1px solid var(--border);margin-bottom:22px;font-size:14px;font-weight:600;color:var(--navy)}
  .check-counter .count-num{font-weight:900;font-size:18px}

  .lead-icon{width:80px;height:80px;border-radius:50%;background:linear-gradient(135deg,var(--navy),var(--navy2));display:flex;align-items:center;justify-content:center;font-size:36px;margin:0 auto 20px}
  .form-group{margin-bottom:18px}
  .form-label{display:block;font-size:13px;font-weight:700;color:var(--navy);margin-bottom:8px}
  .form-input{width:100%;padding:14px 18px;border:2px solid var(--border);border-radius:var(--radius-sm);font-size:15px;background:var(--bg-light);transition:all .2s;outline:none;font-family:inherit}
  .form-input:focus{border-color:var(--navy);background:#fff;box-shadow:0 0 0 4px rgba(26,46,74,.06)}
  .form-input.error{border-color:var(--brand-rojo);background:#fff5f5}
  .error-msg{color:var(--brand-rojo);font-size:12px;margin-top:4px;display:none;font-weight:600}

  .result-badge{display:inline-flex;align-items:center;gap:8px;padding:8px 20px;border-radius:50px;font-size:13px;font-weight:800;text-transform:uppercase;letter-spacing:1px;margin-bottom:20px}
  .result-message{font-size:16px;line-height:1.8;margin-bottom:28px;padding:24px;border-radius:var(--radius-md);text-align:left}
  .insight-card{padding:20px 24px;border-radius:var(--radius-md);margin-bottom:16px;border-left:4px solid;text-align:left}
  .insight-card h4{font-size:15px;margin-bottom:8px}
  .insight-card p{font-size:14px;line-height:1.7;margin:0}
  .scenario-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:12px}
  .scenario-box{padding:16px;border-radius:var(--radius-sm);text-align:left}
  .scenario-box h5{font-size:13px;font-weight:800;margin-bottom:8px;text-transform:uppercase;letter-spacing:.5px}
  .scenario-box ul{list-style:none;padding:0;margin:0}
  .scenario-box ul li{font-size:13px;line-height:1.6;padding:3px 0;padding-left:18px;position:relative}
  .scenario-box ul li::before{content:'';position:absolute;left:0;top:10px;width:8px;height:8px;border-radius:50%}
  .scenario-bad ul li::before{background:var(--brand-rojo)}
  .scenario-good ul li::before{background:var(--brand-verde)}

  .partner-banner{display:flex;align-items:center;gap:16px;background:linear-gradient(135deg,var(--navy3),var(--navy));padding:20px 24px;border-radius:var(--radius-md);margin-bottom:20px;text-align:left}
  .partner-banner img{height:48px;border-radius:8px;background:#fff;padding:6px 10px;flex-shrink:0}
  .partner-banner-text{color:rgba(255,255,255,.85);font-size:13px;line-height:1.6}
  .partner-banner-text strong{color:#fff;display:block;font-size:14px;margin-bottom:2px}

  .gauge-container{display:flex;justify-content:center;margin-bottom:32px}
  .gauge-svg{width:220px;height:130px}
  .gauge-bg{fill:none;stroke:var(--border);stroke-width:14;stroke-linecap:round}
  .gauge-fill{fill:none;stroke-width:14;stroke-linecap:round;transition:stroke-dashoffset 1.5s cubic-bezier(.16,1,.3,1),stroke .5s}
  .gauge-text{font-family:'Plus Jakarta Sans',sans-serif;font-weight:900;font-size:36px;fill:var(--navy);text-anchor:middle}
  .gauge-label{font-family:'DM Sans',sans-serif;font-size:11px;fill:var(--muted);text-anchor:middle;font-weight:600;text-transform:uppercase;letter-spacing:1px}

  .phase-breakdown{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-bottom:28px}
  .pb-item{padding:14px 8px;border-radius:var(--radius-sm);text-align:center}
  .pb-score{font-size:22px;font-weight:900;display:block}
  .pb-label{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.3px;opacity:.8}

  .btn-primary{display:inline-flex;align-items:center;justify-content:center;gap:8px;background:var(--navy);color:#fff;padding:16px 32px;border-radius:var(--radius-sm);font-size:15px;font-weight:700;border:none;cursor:pointer;transition:all .25s;font-family:inherit;width:100%;letter-spacing:.01em}
  .btn-primary:hover{background:var(--navy2);transform:translateY(-1px);box-shadow:var(--shadow-md)}
  .btn-secondary{display:inline-flex;align-items:center;justify-content:center;gap:8px;background:transparent;color:var(--muted);padding:14px 24px;border-radius:var(--radius-sm);font-size:14px;font-weight:600;border:2px solid var(--border);cursor:pointer;transition:all .2s;font-family:inherit}
  .btn-secondary:hover{border-color:var(--navy);color:var(--navy)}
  .btn-cta-big{display:flex;align-items:center;justify-content:center;gap:10px;background:var(--brand-rojo);color:#fff;padding:20px 36px;border-radius:var(--radius-md);font-size:17px;font-weight:800;text-decoration:none;transition:all .3s;box-shadow:0 6px 20px rgba(214,34,22,.25);margin-top:20px;border:none;cursor:pointer;width:100%;font-family:inherit;letter-spacing:.01em}
  .btn-cta-big:hover{transform:translateY(-2px);box-shadow:0 10px 30px rgba(214,34,22,.35);background:#c01e14}

  .step-nav{display:flex;gap:12px;margin-top:32px}
  .step-nav .btn-primary{flex:1}

  @keyframes confetti-fall{0%{transform:translateY(-10px) rotate(0deg);opacity:1}100%{transform:translateY(100vh) rotate(720deg);opacity:0}}
  .confetti{position:fixed;top:-10px;width:10px;height:10px;z-index:9999;pointer-events:none;animation:confetti-fall 3s ease-in forwards}

  .form-row{display:grid;grid-template-columns:1fr 1fr;gap:14px}

  @media(max-width:640px){
    .step-card{padding:28px 20px}
    .chips{gap:8px}.chip{padding:9px 14px;font-size:13px}
    .phase-breakdown{grid-template-columns:repeat(3,1fr);gap:6px}
    .scenario-grid{grid-template-columns:1fr}
    .step-nav{flex-direction:column}.step-nav .btn-secondary{order:1}
    .quiz-wrapper{padding:80px 16px 40px}
    .form-row{grid-template-columns:1fr}
    .partner-banner{flex-direction:column;text-align:center}
  }
</style>
</head>
<body>

<nav>
  <div class="nav-inner">
    <a href="index.html" style="display:flex;align-items:center;text-decoration:none;">
      <img src="assets/mas-logo.svg" alt="MAS Consultores" style="height:44px;">
    </a>
    <a class="nav-back" href="index.html">&larr; Volver al sitio</a>
  </div>
</nav>

<div class="quiz-wrapper">

  <div class="progress-container">
    <div class="progress-header">
      <span class="progress-label">Diagnóstico ROI — Metodología Phillips</span>
      <span class="progress-step-text" id="progressText">Paso 1 de 6</span>
    </div>
    <div class="progress-bar-track">
      <div class="progress-bar-fill" id="progressFill" style="width:16.6%;background:var(--navy);"></div>
    </div>
  </div>

  <div class="step active" id="step1">
    <div class="step-card">
      <span class="step-icon">&#128202;</span>
      <h2 class="step-title">Perfil Organizacional</h2>
      <p class="step-subtitle">Antes de evaluar tu madurez ROI, necesitamos conocer el contexto de tu organización. Esto nos permite entregar un diagnóstico relevante a tu realidad.</p>

      <div class="question-group">
        <span class="question-label">Rubro / Industria</span>
        <div class="chips" data-group="rubro">
          <button class="chip" type="button">Banca y Finanzas</button>
          <button class="chip" type="button">Minería y Energía</button>
          <button class="chip" type="button">Retail y Consumo</button>
          <button class="chip" type="button">Telecomunicaciones</button>
          <button class="chip" type="button">Salud</button>
          <button class="chip" type="button">Tecnología</button>
          <button class="chip" type="button">Educación</button>
          <button class="chip" type="button">Sector Público</button>
          <button class="chip" type="button">Manufactura</button>
          <button class="chip" type="button">Servicios Profesionales</button>
          <button class="chip" type="button">Otro</button>
        </div>
      </div>

      <div class="question-group">
        <span class="question-label">¿Cuántos colaboradores tiene tu organización?</span>
        <div class="chips" data-group="colaboradores">
          <button class="chip" type="button">1-50</button>
          <button class="chip" type="button">51-200</button>
          <button class="chip" type="button">201-1.000</button>
          <button class="chip" type="button">+1.000</button>
        </div>
      </div>

      <div class="question-group">
        <span class="question-label">¿Cuántos años lleva operando la organización?</span>
        <div class="chips" data-group="anos">
          <button class="chip" type="button">0-5 años</button>
          <button class="chip" type="button">6-15 años</button>
          <button class="chip" type="button">16-30 años</button>
          <button class="chip" type="button">+30 años</button>
        </div>
      </div>

      <div class="question-group">
        <span class="question-label">Tu cargo o rol principal</span>
        <div class="chips" data-group="cargo">
          <button class="chip" type="button">Gerente/Director de RRHH</button>
          <button class="chip" type="button">Jefe de Capacitación</button>
          <button class="chip" type="button">BP / HRBP</button>
          <button class="chip" type="button">Analista de Desarrollo</button>
          <button class="chip" type="button">Gerencia General / C-Level</button>
          <button class="chip" type="button">Otro</button>
        </div>
      </div>

      <div class="question-group">
        <span class="question-label">Nivel principal al que destinan capacitación</span>
        <div class="chips" data-group="nivel">
          <button class="chip" type="button">Operarios / Primera Línea</button>
          <button class="chip" type="button">Administrativos</button>
          <button class="chip" type="button">Profesionales / Analistas</button>
          <button class="chip" type="button">Supervisores / Jefaturas</button>
          <button class="chip" type="button">Gerencia / Alta Dirección</button>
          <button class="chip" type="button">Transversal (todos los niveles)</button>
        </div>
      </div>

      <div class="question-group">
        <span class="question-label">Presupuesto anual aproximado en capacitación</span>
        <div class="chips" data-group="presupuesto">
          <button class="chip" type="button">No tenemos asignado</button>
          <button class="chip" type="button">Menos de $20M CLP</button>
          <button class="chip" type="button">$20M - $100M CLP</button>
          <button class="chip" type="button">$100M - $500M CLP</button>
          <button class="chip" type="button">Más de $500M CLP</button>
        </div>
      </div>

      <div class="step-nav">
        <button class="btn-primary" onclick="goToStep(2)">Comenzar evaluación de madurez &rarr;</button>
      </div>
    </div>
  </div>

  <div class="step" id="step2">
    <div class="step-card">
      <span class="step-icon">&#9989;</span>
      <h2 class="step-title">Niveles 1 y 2 — Reacción y Aprendizaje</h2>
      <p class="step-subtitle">Marca las prácticas que tu organización realiza de manera <strong>consistente y documentada</strong>. Si ninguna aplica a tu caso, no te preocupes: simplemente avanza al siguiente paso. La honestidad hace más preciso tu diagnóstico.</p>

      <div class="check-counter" id="counter2">
        <span>Prácticas confirmadas:</span>
        <span class="count-num" id="countNum2">0</span>
        <span>de 8</span>
      </div>

      <div class="phase-header">
        <div class="phase-dot" style="background:var(--nivel1);"></div>
        <span class="phase-name" style="color:var(--nivel1);">Nivel 1 — Reacción y Satisfacción</span>
        <span class="phase-desc">Phillips L1</span>
      </div>
      <label class="check-item" style="color:var(--nivel1);" data-level="1">
        <span class="check-box"><svg viewBox="0 0 16 16"><path d="M3 8.5 L6.5 12 L13 4"/></svg></span>
        <span class="check-text">Aplicamos encuestas de satisfacción estandarizadas al finalizar cada programa.</span>
      </label>
      <label class="check-item" style="color:var(--nivel1);" data-level="1">
        <span class="check-box"><svg viewBox="0 0 16 16"><path d="M3 8.5 L6.5 12 L13 4"/></svg></span>
        <span class="check-text">Medimos la relevancia percibida del contenido para el puesto de trabajo (no solo "me gustó").</span>
      </label>
      <label class="check-item" style="color:var(--nivel1);" data-level="1">
        <span class="check-box"><svg viewBox="0 0 16 16"><path d="M3 8.5 L6.5 12 L13 4"/></svg></span>
        <span class="check-text">Evaluamos la intención de aplicar lo aprendido con preguntas específicas de acción.</span>
      </label>
      <label class="check-item" style="color:var(--nivel1);" data-level="1">
        <span class="check-box"><svg viewBox="0 0 16 16"><path d="M3 8.5 L6.5 12 L13 4"/></svg></span>
        <span class="check-text">Consolidamos y analizamos los datos de reacción para tomar decisiones sobre futuros programas.</span>
      </label>

      <div class="phase-header phase-divider">
        <div class="phase-dot" style="background:var(--nivel2);"></div>
        <span class="phase-name" style="color:var(--nivel2);">Nivel 2 — Aprendizaje</span>
        <span class="phase-desc">Phillips L2</span>
      </div>
      <label class="check-item" style="color:var(--nivel2);" data-level="2">
        <span class="check-box"><svg viewBox="0 0 16 16"><path d="M3 8.5 L6.5 12 L13 4"/></svg></span>
        <span class="check-text">Aplicamos evaluaciones de conocimiento (pre y post) para medir el aprendizaje real.</span>
      </label>
      <label class="check-item" style="color:var(--nivel2);" data-level="2">
        <span class="check-box"><svg viewBox="0 0 16 16"><path d="M3 8.5 L6.5 12 L13 4"/></svg></span>
        <span class="check-text">Utilizamos simulaciones, role-plays o pruebas prácticas para evaluar habilidades adquiridas.</span>
      </label>
      <label class="check-item" style="color:var(--nivel2);" data-level="2">
        <span class="check-box"><svg viewBox="0 0 16 16"><path d="M3 8.5 L6.5 12 L13 4"/></svg></span>
        <span class="check-text">Nuestro LMS o plataforma entrega reportes de completitud, puntajes y estancamiento por usuario.</span>
      </label>
      <label class="check-item" style="color:var(--nivel2);" data-level="2">
        <span class="check-box"><svg viewBox="0 0 16 16"><path d="M3 8.5 L6.5 12 L13 4"/></svg></span>
        <span class="check-text">Los diseños instruccionales se alinean con objetivos de aprendizaje medibles (no genéricos).</span>
      </label>

      <div class="step-nav">
        <button class="btn-secondary" onclick="goToStep(1)">&larr; Volver</button>
        <button class="btn-primary" onclick="goToStep(3)">Siguiente: Niveles 3 y 4 &rarr;</button>
      </div>
    </div>
  </div>

  <div class="step" id="step3">
    <div class="step-card">
      <span class="step-icon">&#128200;</span>
      <h2 class="step-title">Niveles 3 y 4 — Aplicación e Impacto</h2>
      <p class="step-subtitle">Estos niveles miden la transferencia real al puesto de trabajo y el impacto en indicadores del negocio. Si ninguna aplica, avanza sin problema: esto indica dónde están las oportunidades más grandes.</p>

      <div class="check-counter" id="counter3">
        <span>Prácticas confirmadas:</span>
        <span class="count-num" id="countNum3">0</span>
        <span>de 8</span>
      </div>

      <div class="phase-header">
        <div class="phase-dot" style="background:var(--nivel3);"></div>
        <span class="phase-name" style="color:var(--nivel3);">Nivel 3 — Aplicación e Implementación</span>
        <span class="phase-desc">Phillips L3</span>
      </div>
      <label class="check-item" style="color:var(--nivel3);" data-level="3">
        <span class="check-box"><svg viewBox="0 0 16 16"><path d="M3 8.5 L6.5 12 L13 4"/></svg></span>
        <span class="check-text">Los participantes terminan cada programa con un plan de acción concreto a 30-60 días.</span>
      </label>
      <label class="check-item" style="color:var(--nivel3);" data-level="3">
        <span class="check-box"><svg viewBox="0 0 16 16"><path d="M3 8.5 L6.5 12 L13 4"/></svg></span>
        <span class="check-text">Los jefes directos participan activamente (pre-briefing y post-seguimiento de la capacitación).</span>
      </label>
      <label class="check-item" style="color:var(--nivel3);" data-level="3">
        <span class="check-box"><svg viewBox="0 0 16 16"><path d="M3 8.5 L6.5 12 L13 4"/></svg></span>
        <span class="check-text">Realizamos evaluaciones de seguimiento a los 60-90 días para medir cambio de comportamiento.</span>
      </label>
      <label class="check-item" style="color:var(--nivel3);" data-level="3">
        <span class="check-box"><svg viewBox="0 0 16 16"><path d="M3 8.5 L6.5 12 L13 4"/></svg></span>
        <span class="check-text">Identificamos y documentamos las barreras y facilitadores de la aplicación en el puesto.</span>
      </label>

      <div class="phase-header phase-divider">
        <div class="phase-dot" style="background:var(--nivel4);"></div>
        <span class="phase-name" style="color:var(--nivel4);">Nivel 4 — Impacto en el Negocio</span>
        <span class="phase-desc">Phillips L4</span>
      </div>
      <label class="check-item" style="color:var(--nivel4);" data-level="4">
        <span class="check-box"><svg viewBox="0 0 16 16"><path d="M3 8.5 L6.5 12 L13 4"/></svg></span>
        <span class="check-text">Definimos KPIs de negocio vinculados al programa ANTES de ejecutar la capacitación.</span>
      </label>
      <label class="check-item" style="color:var(--nivel4);" data-level="4">
        <span class="check-box"><svg viewBox="0 0 16 16"><path d="M3 8.5 L6.5 12 L13 4"/></svg></span>
        <span class="check-text">Documentamos la "línea base" de esos KPIs para comparar el antes y después.</span>
      </label>
      <label class="check-item" style="color:var(--nivel4);" data-level="4">
        <span class="check-box"><svg viewBox="0 0 16 16"><path d="M3 8.5 L6.5 12 L13 4"/></svg></span>
        <span class="check-text">Aplicamos métodos para aislar los efectos de la capacitación de otros factores (estimación, grupo control, análisis de tendencia).</span>
      </label>
      <label class="check-item" style="color:var(--nivel4);" data-level="4">
        <span class="check-box"><svg viewBox="0 0 16 16"><path d="M3 8.5 L6.5 12 L13 4"/></svg></span>
        <span class="check-text">Reportamos el impacto en indicadores operativos al equipo directivo con datos concretos.</span>
      </label>

      <div class="step-nav">
        <button class="btn-secondary" onclick="goToStep(2)">&larr; Volver</button>
        <button class="btn-primary" onclick="goToStep(4)">Siguiente: Nivel 5 — ROI &rarr;</button>
      </div>
    </div>
  </div>

  <div class="step" id="step4">
    <div class="step-card">
      <span class="step-icon">&#128176;</span>
      <h2 class="step-title">Nivel 5 — Retorno de la Inversión (ROI)</h2>
      <p class="step-subtitle">El nivel más alto de la Metodología Phillips. Aquí se demuestra el valor financiero real de la capacitación. Si ninguna aplica, no te preocupes: menos del 5% de las organizaciones en Latinoamérica opera a este nivel.</p>

      <div class="check-counter" id="counter4">
        <span>Prácticas confirmadas:</span>
        <span class="count-num" id="countNum4">0</span>
        <span>de 4</span>
      </div>

      <div class="phase-header">
        <div class="phase-dot" style="background:var(--nivel5);"></div>
        <span class="phase-name" style="color:var(--nivel5);">Nivel 5 — ROI Financiero</span>
        <span class="phase-desc">Phillips L5</span>
      </div>
      <label class="check-item" style="color:var(--nivel5);" data-level="5">
        <span class="check-box"><svg viewBox="0 0 16 16"><path d="M3 8.5 L6.5 12 L13 4"/></svg></span>
        <span class="check-text">Convertimos las mejoras operativas a valores monetarios utilizando metodologías validadas.</span>
      </label>
      <label class="check-item" style="color:var(--nivel5);" data-level="5">
        <span class="check-box"><svg viewBox="0 0 16 16"><path d="M3 8.5 L6.5 12 L13 4"/></svg></span>
        <span class="check-text">Calculamos el costo TOTAL del programa (diseño, ejecución, tecnología, horas-hombre, costo de oportunidad).</span>
      </label>
      <label class="check-item" style="color:var(--nivel5);" data-level="5">
        <span class="check-box"><svg viewBox="0 0 16 16"><path d="M3 8.5 L6.5 12 L13 4"/></svg></span>
        <span class="check-text">Aplicamos la fórmula de ROI: (Beneficios Netos / Costos) x 100 para obtener el porcentaje de retorno.</span>
      </label>
      <label class="check-item" style="color:var(--nivel5);" data-level="5">
        <span class="check-box"><svg viewBox="0 0 16 16"><path d="M3 8.5 L6.5 12 L13 4"/></svg></span>
        <span class="check-text">Presentamos un reporte financiero de ROI al C-Level o Directorio (no solo métricas de horas o asistencia).</span>
      </label>

      <div class="step-nav">
        <button class="btn-secondary" onclick="goToStep(3)">&larr; Volver</button>
        <button class="btn-primary" onclick="goToStep(5)">Ver mi resultado &rarr;</button>
      </div>
    </div>
  </div>

  <div class="step" id="step5">
    <div class="step-card" style="text-align:center;">
      <div class="lead-icon">&#128274;</div>
      <h2 class="step-title">¡Tu diagnóstico está listo!</h2>
      <p class="step-subtitle" style="max-width:440px;margin:0 auto 32px;">Ingresa tus datos para ver tu puntaje según la Metodología ROI de Phillips y recibir un análisis personalizado.</p>

      <div style="text-align:left;">
        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="leadNombre">Nombre completo *</label>
            <input class="form-input" id="leadNombre" type="text" placeholder="Tu nombre" required>
            <div class="error-msg" id="errorNombre">Este campo es obligatorio</div>
          </div>
          <div class="form-group">
            <label class="form-label" for="leadEmpresa">Empresa *</label>
            <input class="form-input" id="leadEmpresa" type="text" placeholder="Nombre de tu empresa">
            <div class="error-msg" id="errorEmpresa">Este campo es obligatorio</div>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label" for="leadEmail">Email Corporativo *</label>
          <input class="form-input" id="leadEmail" type="email" placeholder="tu@empresa.cl" required>
          <div class="error-msg" id="errorEmail">Ingresa un email corporativo válido</div>
        </div>
      </div>

      <div class="step-nav" style="flex-direction:column;gap:10px;">
        <button class="btn-primary" onclick="submitLead()" style="background:var(--brand-morado);font-size:16px;padding:18px;">&#128161; Ver mi Puntaje y Diagnóstico Ahora</button>
        <button class="btn-secondary" onclick="goToStep(4)" style="width:100%;justify-content:center;">&larr; Volver al checklist</button>
      </div>
      <p style="color:var(--muted);font-size:12px;margin-top:16px;">&#128274; Tu información es confidencial y no será compartida con terceros.</p>
    </div>
  </div>

  <div class="step" id="step6">
    <div class="step-card" style="text-align:center;">
      <div id="resultContent"></div>

      <a class="btn-cta-big" href="index.html#contacto">
        &#128640; Analizar resultados con un experto certificado
      </a>
      <button class="btn-secondary" onclick="downloadResultsPdf()" style="width:100%;margin-top:12px;justify-content:center;">
        &#128190; Descargar respuestas y resultado en PDF
      </button>
      <button class="btn-secondary" onclick="resetQuiz()" style="width:100%;margin-top:12px;justify-content:center;">&#128260; Repetir diagnóstico</button>
    </div>
  </div>

</div>

<script>
const profile = {};
let currentStep = 1;
const totalSteps = 6;

document.querySelectorAll('.chips').forEach(container => {
  const group = container.dataset.group;
  container.querySelectorAll('.chip').forEach(chip => {
    chip.addEventListener('click', () => {
      container.querySelectorAll('.chip').forEach(c => c.classList.remove('selected'));
      chip.classList.add('selected');
      profile[group] = chip.textContent;
    });
  });
});

document.querySelectorAll('.check-item').forEach(item => {
  item.addEventListener('click', () => {
    item.classList.toggle('checked');
    updateCounters();
  });
});

function updateCounters() {
  const c2 = document.getElementById('countNum2');
  const c3 = document.getElementById('countNum3');
  const c4 = document.getElementById('countNum4');
  if(c2) c2.textContent = document.querySelectorAll('#step2 .check-item.checked').length;
  if(c3) c3.textContent = document.querySelectorAll('#step3 .check-item.checked').length;
  if(c4) c4.textContent = document.querySelectorAll('#step4 .check-item.checked').length;
}

function goToStep(n) {
  if (currentStep === 1 && n > 1) {
    if (!profile.colaboradores) {
      const el = document.querySelector('[data-group="colaboradores"]');
      el.style.outline = '2px solid var(--brand-rojo)';
      el.style.outlineOffset = '4px';
      el.style.borderRadius = '12px';
      setTimeout(() => el.style.outline = 'none', 2000);
      return;
    }
  }
  currentStep = n;
  document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
  document.getElementById('step' + n).classList.add('active');

  const pct = (n / totalSteps) * 100;
  const fill = document.getElementById('progressFill');
  fill.style.width = pct + '%';
  const colors = { 1:'var(--navy)', 2:'var(--nivel1)', 3:'var(--nivel3)', 4:'var(--nivel5)', 5:'var(--brand-morado)', 6:'var(--brand-verde)' };
  fill.style.background = colors[n] || 'var(--navy)';
  document.getElementById('progressText').textContent = 'Paso ' + n + ' de ' + totalSteps;
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function submitLead() {
  const nombre = document.getElementById('leadNombre');
  const empresa = document.getElementById('leadEmpresa');
  const email = document.getElementById('leadEmail');
  let valid = true;

  [nombre, empresa].forEach(el => {
    const errId = 'error' + el.id.replace('lead','');
    if (!el.value.trim()) {
      el.classList.add('error');
      document.getElementById(errId).style.display = 'block';
      valid = false;
    } else {
      el.classList.remove('error');
      document.getElementById(errId).style.display = 'none';
    }
  });

  if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email.value)) {
    email.classList.add('error');
    document.getElementById('errorEmail').style.display = 'block';
    valid = false;
  } else {
    email.classList.remove('error');
    document.getElementById('errorEmail').style.display = 'none';
  }

  if (!valid) return;
  profile.nombre = nombre.value.trim();
  profile.empresa = empresa.value.trim();
  profile.email = email.value.trim();

  console.log('Lead Diagnóstico ROI:', profile);
  calculateResults();
  goToStep(6);
  launchConfetti();
}

function calculateResults() {
  const allChecked = document.querySelectorAll('.check-item.checked');
  const total = allChecked.length;
  const maxScore = 20;
  const levels = { 1:0, 2:0, 3:0, 4:0, 5:0 };
  allChecked.forEach(item => { const l = item.dataset.level; if(l) levels[l]++; });

  let tier, tierColor, tierBg, tierLabel, message;
  if (total >= 16) {
    tier = 'experto'; tierColor = 'var(--brand-verde)'; tierBg = '#e6f7ed'; tierLabel = 'Ecosistema Maduro';
    message = '¡Excelente! Tu organización opera en los niveles más altos de la Metodología Phillips. Tienes un ecosistema de medición maduro y eres candidato ideal para optimizar con IA (Colossyan), certificar a tu equipo y escalar tus resultados a nivel regional.';
  } else if (total >= 10) {
    tier = 'intermedio'; tierColor = 'var(--brand-amarillo)'; tierBg = '#fef8e6'; tierLabel = 'En Desarrollo';
    message = 'Tu organización mide reacción y aprendizaje, pero el puente hacia el impacto financiero está incompleto. Probablemente operas bien en los Niveles 1 y 2, pero faltan procesos estructurados de transferencia (L3), impacto (L4) y ROI financiero (L5). Aquí es donde se pierde la mayor parte del valor de la inversión en capacitación.';
  } else {
    tier = 'riesgo'; tierColor = 'var(--brand-rojo)'; tierBg = '#fde8e6'; tierLabel = 'Zona de Riesgo';
    message = 'Tu presupuesto de capacitación opera como un "gasto ciego": se invierte sin evidencia de retorno. Tienes una oportunidad urgente de instalar procesos medibles según la Metodología Phillips antes de tu próximo ciclo presupuestario. La buena noticia es que el margen de mejora es enorme.';
  }

  const colabVal = profile.colaboradores || '';
  const anosVal = profile.anos || '';
  const nivelVal = profile.nivel || '';
  const presupVal = profile.presupuesto || '';

  let analysisHTML = '';

  if (colabVal === '+1.000') {
    analysisHTML += buildInsightWithScenarios('var(--brand-morado)','#f9f0fa',
      '&#127981; Organización de Gran Escala (+1.000 colaboradores)',
      'Con más de 1.000 colaboradores, cada punto de ineficiencia en capacitación se multiplica exponencialmente. Sin medición de niveles 3-5, estás frente a un costo oculto que puede superar varias veces tu presupuesto de formación.',
      ['Presupuestos multimillonarios sin retorno demostrable al directorio','Alta rotación en mandos medios por desarrollo no estructurado','Programas genéricos duplicados entre áreas sin gobernanza central','RRHH percibido como centro de costo, no como socio estratégico'],
      ['ROI medible por unidad de negocio que justifica cada programa','Reducción de rotación del 15-25% instalando procesos de transferencia','Escalamiento con IA y contenido asincrónico certificado','RRHH posicionado ante el directorio con reportes de impacto financiero']
    );
  } else if (colabVal === '201-1.000') {
    analysisHTML += buildInsightWithScenarios('var(--brand-morado)','#f9f0fa',
      '&#127970; Organización en Crecimiento (201-1.000 colaboradores)',
      'Tu organización está en un punto crítico: los procesos informales de capacitación que funcionaban con menos personas comienzan a romperse. La falta de estructura de medición se vuelve costosa a esta escala.',
      ['Duplicidad de esfuerzos entre áreas sin estrategia centralizada','Pérdida de talento clave por falta de desarrollo medible','Costos crecientes de onboarding sin métricas de efectividad','Incapacidad de estandarizar calidad formativa entre sedes'],
      ['Procesos estandarizados de medición que escalan con la empresa','Métricas de transferencia que identifican qué programas funcionan','Reducción del tiempo de ramp-up en un 30-40%','Base sólida de datos para decisiones estratégicas de inversión']
    );
  } else if (colabVal === '51-200') {
    analysisHTML += buildInsightWithScenarios('var(--brand-azul)','#eef1fa',
      '&#128188; Organización Mediana (51-200 colaboradores)',
      'A tu escala, cada inversión en capacitación tiene un impacto proporcionalmente alto. La ventaja es que puedes instalar procesos de medición Phillips rápidamente antes de que la complejidad organizacional crezca.',
      ['Capacitación reactiva: solo se invierte ante crisis de desempeño','Presupuesto gastado en cursos genéricos sin impacto medible','Dependencia de "capacitadores estrella" sin transferencia de know-how','Sin datos para priorizar qué formación genera mayor retorno'],
      ['Programas focalizados en las competencias que más impactan el negocio','Medición desde el día uno que justifica cada peso invertido','Cultura de aprendizaje que atrae y retiene talento','Ventaja competitiva frente a empresas que no miden']
    );
  } else if (colabVal === '1-50') {
    analysisHTML += buildInsightWithScenarios('var(--brand-azul)','#eef1fa',
      '&#128640; Organización en Etapa Inicial (1-50 colaboradores)',
      'Tu tamaño es tu mayor ventaja. Puedes instalar una cultura de medición ROI desde los cimientos, algo que las grandes empresas luchan por lograr después.',
      ['Aprendizaje informal sin seguimiento ni evaluación','Riesgo de perder talento por falta de desarrollo profesional','Inversiones puntuales desconectadas de objetivos de negocio','Onboarding inefectivo que alarga la curva de productividad'],
      ['Cultura de alto rendimiento desde los cimientos','Formación alineada directamente con OKRs del negocio','Employer branding que compite con empresas más grandes','Base de datos de impacto que crece con la empresa']
    );
  }

  if (anosVal === '+30 años') {
    analysisHTML += buildInsight('var(--navy)','#eef2f7','&#127942; Trayectoria: +30 años de operación',
      'Organizaciones con tu madurez enfrentan la <strong>inercia del "siempre se ha hecho así"</strong>. Probablemente tienes décadas de programas acumulados, pero sin un framework Phillips, es imposible saber cuáles generan valor y cuáles solo consumen presupuesto. La transformación digital y generacional exige reinventar cómo se desarrolla el talento.');
  } else if (anosVal === '16-30 años') {
    analysisHTML += buildInsight('var(--navy)','#eef2f7','&#128218; Trayectoria: 16 a 30 años',
      'Tu organización tiene madurez suficiente para que la capacitación deje de ser un "costo de operación" y se convierta en una <strong>inversión estratégica medible</strong>. No instalar la Metodología Phillips a esta altura significa acumular años de gasto sin retorno demostrable.');
  } else if (anosVal === '6-15 años') {
    analysisHTML += buildInsight('var(--navy)','#eef2f7','&#9889; Trayectoria: 6 a 15 años',
      '<strong>Las decisiones de hoy definen la cultura de los próximos 10 años.</strong> Instalar medición Phillips ahora te da una ventaja enorme: cuando crezcas, ya tendrás datos históricos que justifiquen cada inversión.');
  } else if (anosVal === '0-5 años') {
    analysisHTML += buildInsight('var(--navy)','#eef2f7','&#127793; Empresa joven (0-5 años)',
      'Tienes una oportunidad única: <strong>construir desde cero con la Metodología Phillips</strong>. Las empresas que instalan cultura de medición desde el inicio escalan 2-3x más rápido que las que dejan esto "para después".');
  }

  if (nivelVal.includes('Supervisor') || nivelVal.includes('Jefatura') || nivelVal.includes('Gerencia') || nivelVal.includes('Alta')) {
    analysisHTML += buildInsight('var(--brand-rojo)','#fde8e6','&#128680; Alerta: Capacitación de Líderes sin Medición ROI',
      'Al capacitar a <strong>' + escapeHTML(nivelVal) + '</strong>, el riesgo se amplifica: un líder mal capacitado cuesta hasta <strong>3 veces su salario anual</strong> en rotación, desmotivación y pérdida de productividad. Medir los 5 niveles Phillips en programas de liderazgo es crítico.');
  }

  if (presupVal.includes('100M') || presupVal.includes('500M')) {
    analysisHTML += buildInsight('var(--brand-amarillo)','#fef8e6','&#128176; Alerta Presupuestaria',
      'Con un presupuesto de <strong>' + escapeHTML(presupVal) + '</strong> anuales, cada programa sin medición de Nivel 4 y 5 representa una cantidad significativa de recursos que no puedes justificar financieramente. La Metodología Phillips te permite demostrar exactamente qué retorno genera cada peso invertido.');
  }

  const partnerHTML = '<div class="partner-banner">' +
    '<img src="assets/roi-logo.svg" alt="ROI Institute" onerror="this.style.display=\'none\'">' +
    '<div class="partner-banner-text">' +
      '<strong>MAS Consultores — Único Partner Oficial del ROI Institute en Latinoamérica</strong>' +
      'Somos el único partner certificado por Jack Phillips en la región desde 2003. No solo aplicamos la Metodología ROI: también <strong>certificamos a tu equipo interno</strong> para que tu organización pueda medir el retorno de la inversión en talento de forma autónoma y sostenible.' +
    '</div>' +
  '</div>';

  const arcLength = 251;
  const offset = arcLength - (total / maxScore) * arcLength;
  const strokeColor = tierColor.replace('var(--brand-verde)','#009739').replace('var(--brand-amarillo)','#edb321').replace('var(--brand-rojo)','#d62216');
  const textColor = tierColor.replace('var(--brand-verde)','#006628').replace('var(--brand-amarillo)','#7a5a00').replace('var(--brand-rojo)','#8b1610');

  const html =
    '<div class="result-badge" style="background:'+tierBg+';color:'+tierColor+';">' +
      '<span style="font-size:16px;">'+(tier==='experto'?'&#127942;':tier==='intermedio'?'&#9888;&#65039;':'&#128680;')+'</span> ' + tierLabel +
    '</div>' +
    '<div class="gauge-container">' +
      '<svg class="gauge-svg" viewBox="0 0 200 120">' +
        '<path class="gauge-bg" d="M 20 100 A 80 80 0 0 1 180 100"/>' +
        '<path class="gauge-fill" d="M 20 100 A 80 80 0 0 1 180 100" stroke="'+strokeColor+'" stroke-dasharray="'+arcLength+'" stroke-dashoffset="'+offset+'"/>' +
        '<text class="gauge-text" x="100" y="90">'+total+'</text>' +
        '<text class="gauge-label" x="100" y="110">de '+maxScore+' puntos</text>' +
      '</svg>' +
    '</div>' +
    '<div class="phase-breakdown">' +
      '<div class="pb-item" style="background:#f9f0fa;color:var(--nivel1);"><span class="pb-score">'+levels[1]+'/4</span><span class="pb-label">N1 Reacción</span></div>' +
      '<div class="pb-item" style="background:#fef8e6;color:#b8860b;"><span class="pb-score">'+levels[2]+'/4</span><span class="pb-label">N2 Aprendizaje</span></div>' +
      '<div class="pb-item" style="background:#e6f7ed;color:var(--nivel3);"><span class="pb-score">'+levels[3]+'/4</span><span class="pb-label">N3 Aplicación</span></div>' +
      '<div class="pb-item" style="background:#fde8e6;color:var(--nivel4);"><span class="pb-score">'+levels[4]+'/4</span><span class="pb-label">N4 Impacto</span></div>' +
      '<div class="pb-item" style="background:#eef1fa;color:var(--nivel5);"><span class="pb-score">'+levels[5]+'/4</span><span class="pb-label">N5 ROI</span></div>' +
    '</div>' +
    '<div class="result-message" style="background:'+tierBg+';color:'+textColor+';">' +
      '<strong style="display:block;margin-bottom:6px;font-size:18px;">&#128203; Diagnóstico para '+escapeHTML(profile.nombre||'')+' — '+escapeHTML(profile.empresa||'')+'</strong>' +
      message +
    '</div>' +
    partnerHTML +
    analysisHTML;

  document.getElementById('resultContent').innerHTML = html;
}

function buildInsight(color, bg, title, text) {
  return '<div class="insight-card" style="border-color:'+color+';background:'+bg+';"><h4 style="color:'+color+';">'+title+'</h4><p>'+text+'</p></div>';
}
function buildInsightWithScenarios(color, bg, title, intro, bad, good) {
  let bl='',gl='';
  bad.forEach(function(i){bl+='<li>'+i+'</li>';});
  good.forEach(function(i){gl+='<li>'+i+'</li>';});
  return '<div class="insight-card" style="border-color:'+color+';background:'+bg+';"><h4 style="color:'+color+';">'+title+'</h4><p>'+intro+'</p>' +
    '<div class="scenario-grid">' +
    '<div class="scenario-box scenario-bad" style="background:rgba(214,34,22,.06);border-radius:12px;"><h5 style="color:var(--brand-rojo);">&#128308; Si sigues sin medir</h5><ul>'+bl+'</ul></div>' +
    '<div class="scenario-box scenario-good" style="background:rgba(0,151,57,.06);border-radius:12px;"><h5 style="color:var(--brand-verde);">&#128994; Si actúas ahora</h5><ul>'+gl+'</ul></div>' +
    '</div></div>';
}

function launchConfetti() {
  const colors=['#833d8e','#edb321','#009739','#d62216','#23398d','#1a2e4a'];
  for(let i=0;i<50;i++){
    const el=document.createElement('div');
    el.className='confetti';
    el.style.left=Math.random()*100+'vw';
    el.style.background=colors[Math.floor(Math.random()*colors.length)];
    el.style.width=(Math.random()*8+6)+'px';
    el.style.height=(Math.random()*8+6)+'px';
    el.style.borderRadius=Math.random()>.5?'50%':'2px';
    el.style.animationDuration=(Math.random()*2+2)+'s';
    el.style.animationDelay=(Math.random()*.8)+'s';
    document.body.appendChild(el);
    setTimeout(()=>el.remove(),4000);
  }
}

function resetQuiz() {
  document.querySelectorAll('.chip').forEach(c=>c.classList.remove('selected'));
  document.querySelectorAll('.check-item').forEach(c=>c.classList.remove('checked'));
  ['leadNombre','leadEmpresa','leadEmail'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
  ['countNum2','countNum3','countNum4'].forEach(id=>{const el=document.getElementById(id);if(el)el.textContent='0';});
  Object.keys(profile).forEach(k=>delete profile[k]);
  goToStep(1);
}

function getTierSummary(total) {
  if (total >= 16) {
    return {
      label: 'Ecosistema Maduro',
      detalle: 'Tu organización opera en los niveles más altos de la Metodología Phillips.'
    };
  }
  if (total >= 10) {
    return {
      label: 'En Desarrollo',
      detalle: 'Tu organización tiene avances, pero aún faltan procesos estructurados para demostrar impacto financiero.'
    };
  }
  return {
    label: 'Zona de Riesgo',
    detalle: 'Hoy existe alta inversión sin evidencia clara de retorno. La oportunidad de mejora es significativa.'
  };
}

function getSelectedAnswersByLevel() {
  const levels = {
    1: 'Nivel 1 — Reacción',
    2: 'Nivel 2 — Aprendizaje',
    3: 'Nivel 3 — Aplicación',
    4: 'Nivel 4 — Impacto',
    5: 'Nivel 5 — ROI'
  };

  const answers = { 1: [], 2: [], 3: [], 4: [], 5: [] };
  document.querySelectorAll('.check-item.checked').forEach(item => {
    const level = item.dataset.level;
    if (!level || !answers[level]) return;
    const text = item.querySelector('.check-text');
    if (text && text.textContent.trim()) answers[level].push(text.textContent.trim());
  });

  return { levels, answers };
}

function addWrappedText(doc, text, x, y, maxWidth, lineHeight, isBold) {
  doc.setFont('helvetica', isBold ? 'bold' : 'normal');
  const lines = doc.splitTextToSize(text, maxWidth);
  doc.text(lines, x, y);
  return y + (lines.length * lineHeight);
}

async function createMasWatermarkDataUrl() {
  return new Promise((resolve) => {
    const img = new Image();
    img.onload = () => {
      const canvas = document.createElement('canvas');
      canvas.width = img.naturalWidth;
      canvas.height = img.naturalHeight;
      const ctx = canvas.getContext('2d');
      if (!ctx) {
        resolve(null);
        return;
      }
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.globalAlpha = 0.08;
      ctx.drawImage(img, 0, 0);
      resolve(canvas.toDataURL('image/png'));
    };
    img.onerror = () => resolve(null);
    img.src = 'assets/mas-logo.svg';
  });
}

async function downloadResultsPdf() {
  if (!window.jspdf || !window.jspdf.jsPDF) {
    alert('No fue posible generar el PDF en este momento. Intenta nuevamente.');
    return;
  }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: 'pt', format: 'a4' });
  const pageWidth = doc.internal.pageSize.getWidth();
  const pageHeight = doc.internal.pageSize.getHeight();
  const margin = 48;
  const contentWidth = pageWidth - (margin * 2);
  const lineHeight = 16;

  const watermark = await createMasWatermarkDataUrl();

  function applyWatermark() {
    if (!watermark) return;
    const wmWidth = 340;
    const wmHeight = 220;
    const x = (pageWidth - wmWidth) / 2;
    const y = (pageHeight - wmHeight) / 2;
    doc.addImage(watermark, 'PNG', x, y, wmWidth, wmHeight, undefined, 'FAST');
  }

  function ensureSpace(y, needed) {
    if (y + needed <= pageHeight - margin) return y;
    doc.addPage();
    applyWatermark();
    return margin;
  }

  const total = document.querySelectorAll('.check-item.checked').length;
  const summary = getTierSummary(total);
  const { levels, answers } = getSelectedAnswersByLevel();

  applyWatermark();
  let y = margin;

  doc.setTextColor(26, 46, 74);
  doc.setFontSize(22);
  doc.setFont('helvetica', 'bold');
  doc.text('Diagnóstico ROI - Reporte Personalizado', margin, y);

  y += 28;
  doc.setFontSize(11);
  doc.setFont('helvetica', 'normal');
  doc.setTextColor(100, 116, 139);
  doc.text('MAS Consultores | Único Partner Oficial del ROI Institute en Latinoamérica', margin, y);

  y += 28;
  doc.setFontSize(12);
  doc.setTextColor(51, 65, 85);
  y = addWrappedText(doc, 'Nombre: ' + (profile.nombre || 'No registrado'), margin, y, contentWidth, lineHeight, true);
  y = addWrappedText(doc, 'Empresa: ' + (profile.empresa || 'No registrada'), margin, y + 4, contentWidth, lineHeight, true);
  y = addWrappedText(doc, 'Email: ' + (profile.email || 'No registrado'), margin, y + 4, contentWidth, lineHeight, false);

  y += 12;
  y = ensureSpace(y, 90);
  doc.setDrawColor(226, 232, 240);
  doc.roundedRect(margin, y, contentWidth, 74, 8, 8, 'S');
  y += 22;
  doc.setFontSize(14);
  doc.setTextColor(15, 31, 51);
  doc.setFont('helvetica', 'bold');
  doc.text('Resultado: ' + summary.label + ' (' + total + '/20)', margin + 14, y);
  y += 20;
  doc.setFontSize(11);
  doc.setTextColor(51, 65, 85);
  doc.setFont('helvetica', 'normal');
  y = addWrappedText(doc, summary.detalle, margin + 14, y, contentWidth - 28, 14, false);
  y += 16;

  doc.setFontSize(15);
  doc.setTextColor(26, 46, 74);
  doc.setFont('helvetica', 'bold');
  doc.text('Respuestas seleccionadas', margin, y);
  y += 20;

  Object.keys(levels).forEach(level => {
    const selected = answers[level];
    y = ensureSpace(y, 36);
    doc.setFontSize(12);
    doc.setTextColor(35, 57, 98);
    doc.setFont('helvetica', 'bold');
    doc.text(levels[level] + ' (' + selected.length + '/4)', margin, y);
    y += 16;

    if (!selected.length) {
      y = ensureSpace(y, 22);
      doc.setFontSize(11);
      doc.setTextColor(100, 116, 139);
      doc.setFont('helvetica', 'italic');
      doc.text('- Sin respuestas seleccionadas.', margin + 12, y);
      y += 16;
      return;
    }

    selected.forEach(answer => {
      y = ensureSpace(y, 48);
      doc.setFontSize(11);
      doc.setTextColor(51, 65, 85);
      doc.setFont('helvetica', 'normal');
      y = addWrappedText(doc, '- ' + answer, margin + 12, y, contentWidth - 12, 14, false);
      y += 4;
    });
    y += 8;
  });

  const totalPages = doc.getNumberOfPages();
  for (let i = 1; i <= totalPages; i++) {
    doc.setPage(i);
    doc.setFontSize(9);
    doc.setTextColor(148, 163, 184);
    doc.text('Página ' + i + ' de ' + totalPages, pageWidth - margin, pageHeight - 24, { align: 'right' });
  }

  const safeName = (profile.nombre || 'diagnostico').toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '') || 'diagnostico';
  doc.save('diagnostico-roi-' + safeName + '.pdf');
}

function escapeHTML(str){const d=document.createElement('div');d.textContent=str;return d.innerHTML;}
</script>
</body>
</html>
